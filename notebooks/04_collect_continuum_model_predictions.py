import numpy as np
import pandas as pd

from scipy.interpolate import interp1d
from soil_diskin.continuum_models import GammaDisKin, PowerLawDisKin, GeneralPowerLawDisKin

"""
Collects the continuum model predictions for all sites and saves them to CSV files.
"""

# Load the site data
site_data = pd.read_csv('results/processed_balesdent_2018.csv')
turnover_14C = pd.read_csv('results/all_sites_14C_turnover.csv')

#%% Gamma model

# load the gamma model parameters to generate predictions
fname = 'gamma_model_optimization_results.csv'
gamma_params = pd.read_csv(f'results/03_calibrate_models/{fname}')

print("Generating gamma model predictions...")
predictions = []
for i, row in gamma_params.iterrows():
    model = GammaDisKin(a=row['a'], b=row['b'])
    if not model.params_valid():
        print(f"Invalid parameters for site {i}: a={row['a']}, b={row['b']}")
    predictions.append(model.cdfA(site_data.loc[i, 'Duration_labeling']))
predictions = np.array(predictions)
# Save the model predictions
np.savetxt(f'results/04_model_predictions/gamma.csv', predictions)

#%% Power-law model

# load the power-law parameters
fname = 'powerlaw_model_optimization_results.csv'
power_law_params = pd.read_csv(f'results/03_calibrate_models/{fname}')

print("Generating power-law model predictions...")
predictions = []
for i, row in power_law_params.iterrows():
    model = PowerLawDisKin(t_min=row['t_min'], t_max=row['t_max'])
    if not model.params_valid():
        print(f"Invalid parameters for site {i}: t_min={row['tau_0']}, t_max={row['tau_inf']}")
    predictions.append(model.cdfA(site_data.loc[i, 'Duration_labeling']))
predictions = np.array(predictions)
# Save the model predictions
np.savetxt(f'results/04_model_predictions/power_law.csv', predictions)

#%% Generalized Power-law model with beta = np.exp(-GAMMA)

# load the power-law parameters
fname = 'general_powerlaw_model_optimization_results.csv'
general_power_law_params = pd.read_csv(f'results/03_calibrate_models/{fname}')

print("Generating generalized power-law model predictions...")
predictions = []
for i, row in general_power_law_params.iterrows():
    model = GeneralPowerLawDisKin(t_min=row['t_min'], t_max=row['t_max'], beta=row['beta'])
    if not model.params_valid():
        print(f"Invalid parameters for site {i}: t_min={row['t_min']}, t_max={row['t_max']}, beta={row['beta']}")
    
    predictions.append(model.cdfA(site_data.loc[i, 'Duration_labeling']))
predictions = np.array(predictions)
# Save the model predictions
np.savetxt(f'results/04_model_predictions/general_power_law.csv', predictions)

#%% Generalized Power-law model with beta = np.exp(-GAMMA) / 2

# load the power-law parameters
fname = 'general_powerlaw_model_optimization_results_beta_half.csv'
general_power_law_params = pd.read_csv(f'results/03_calibrate_models/{fname}')

print("Generating generalized power-law model predictions...")
predictions = []
for i, row in general_power_law_params.iterrows():
    model = GeneralPowerLawDisKin(t_min=row['t_min'], t_max=row['t_max'], beta=row['beta'])
    if not model.params_valid():
        print(f"Invalid parameters for site {i}: t_min={row['t_min']}, t_max={row['t_max']}, beta={row['beta']}")
    
    predictions.append(model.cdfA(site_data.loc[i, 'Duration_labeling']))
predictions = np.array(predictions)

# Save the model predictions
np.savetxt(f'results/04_model_predictions/general_power_law_beta_half.csv', predictions)

#%% Lognormal model

# read lognormal cdfs that were generated by the julia script - 04b_lognormal_predictions.jl
print("Generating lognormal model predictions...")
fname = '04b_lognormal_cdfs.csv'
lognormal_cdfs = pd.read_csv(f'results/04_model_predictions/{fname}')
ts = lognormal_cdfs.columns.astype(float).values
predictions = []
for i, row in site_data.iterrows():
    site_cdf = interp1d(ts, lognormal_cdfs.loc[i, :].values / turnover_14C.loc[i, 'turnover'])
    predictions.append(site_cdf(row['Duration_labeling']))
predictions = np.array(predictions)
# Save the model predictions
np.savetxt(f'results/04_model_predictions/lognormal.csv', predictions)
